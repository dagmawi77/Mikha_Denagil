{% extends "base.html" %}

{% block title %}Monthly Contribution Report - የወር መዋጮ ሪፖርት{% endblock %}

{% block content %}
<style>
    .report-header {
        background: linear-gradient(135deg, #14860C 0%, #106b09 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(20, 134, 12, 0.2);
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 2rem;
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="report-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-2"><i class="fa fa-bar-chart me-3"></i>የወር መዋጮ ሪፖርት - Monthly Contribution Report</h2>
                <p class="mb-0" style="opacity: 0.9;">Track contribution trends and performance</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-light me-2" onclick="exportToExcel()" style="border-radius: 10px;">
                    <i class="fa fa-file-excel-o me-2"></i>Export Excel
                </button>
                <button class="btn btn-light" onclick="window.print()" style="border-radius: 10px;">
                    <i class="fa fa-print me-2"></i>Print
                </button>
            </div>
        </div>
    </div>
    
    <!-- Overall Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-number" style="color: #14860C;">{{ "%.2f"|format(overall_stats.grand_total) }}</div>
                <div class="stat-label">Grand Total (Birr)<br>ጠቅላላ ድምር</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-number" style="color: #17a2b8;">{{ overall_stats.total_transactions }}</div>
                <div class="stat-label">Total Transactions<br>ጠቅላላ ግብይቶች</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-number" style="color: #6f42c1;">{{ overall_stats.unique_contributors }}</div>
                <div class="stat-label">Unique Contributors<br>ልዩ አበርካቾች</div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="search-box mb-4">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold">Contribution Type</label>
                <select class="form-control" name="type_id">
                    <option value="">All Types</option>
                    {% for ctype in contrib_types %}
                    <option value="{{ ctype[0] }}" {% if type_filter == ctype[0]|string %}selected{% endif %}>
                        {{ ctype[1] }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label fw-bold">Month</label>
                <input type="month" class="form-control" name="month" value="{{ month_filter }}">
            </div>
            
            <div class="col-md-3">
                <label class="form-label fw-bold">Year</label>
                <input type="number" class="form-control" name="year" value="{{ year_filter }}" min="2020" max="2100">
            </div>
            
            <div class="col-md-3">
                <button type="submit" class="btn btn-success w-100">
                    <i class="fa fa-filter me-2"></i>Filter
                </button>
            </div>
        </form>
    </div>
    
    <!-- Trend Chart -->
    <div class="book-form-card mb-4">
        <h4 class="mb-3" style="color: #14860C; font-weight: 700;">
            <i class="fa fa-line-chart me-2"></i>12-Month Contribution Trend - የ12 ወር አዝማሚያ
        </h4>
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
    
    <!-- Monthly Report Table -->
    <div class="book-table-card">
        <div class="p-3" style="background: linear-gradient(135deg, #14860C 0%, #106b09 100%);">
            <h4 class="text-white mb-0">
                <i class="fa fa-table me-2"></i>Monthly Breakdown - የወር ክፍፍል
            </h4>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="reportTable">
                <thead>
                    <tr>
                        <th>Month / ወር</th>
                        <th>Type / አይነት</th>
                        <th>Contributors / አበርካቾች</th>
                        <th>Transactions / ግብይቶች</th>
                        <th>Total Amount (Birr) / ጠቅላላ መጠን</th>
                    </tr>
                </thead>
                <tbody>
                    {% if monthly_data %}
                        {% for row in monthly_data %}
                        <tr>
                            <td><strong>{{ row[0] }}</strong></td>
                            <td><span class="badge bg-info">{{ row[1] }}</span></td>
                            <td>{{ row[2] }}</td>
                            <td>{{ row[4] }}</td>
                            <td><strong style="color: #14860C;">{{ "%.2f"|format(row[3]) }} Birr</strong></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <i class="fa fa-bar-chart fa-3x text-muted mb-3" style="display: block;"></i>
                                <h5 class="text-muted">No data available</h5>
                                <p class="text-muted">Try adjusting your filters</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
                {% if monthly_data %}
                <tfoot style="background: #f8f9fa; font-weight: bold;">
                    <tr>
                        <td colspan="4" class="text-end">Total:</td>
                        <td style="color: #14860C;">
                            {{ "%.2f"|format(monthly_data|sum(attribute=3) if monthly_data else 0) }} Birr
                        </td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Trend Chart
const ctx = document.getElementById('trendChart').getContext('2d');
const trendChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ chart_labels|tojson }},
        datasets: [{
            label: 'Monthly Contributions (Birr)',
            data: {{ chart_amounts|tojson }},
            backgroundColor: 'rgba(20, 134, 12, 0.7)',
            borderColor: 'rgba(20, 134, 12, 1)',
            borderWidth: 2,
            borderRadius: 8
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' Birr';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toFixed(0) + ' Birr';
                    }
                }
            }
        }
    }
});

// Export to Excel
function exportToExcel() {
    const table = document.getElementById('reportTable');
    let html = table.outerHTML;
    const blob = new Blob([html], {
        type: 'application/vnd.ms-excel'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'contribution_report_' + new Date().toISOString().split('T')[0] + '.xls';
    a.click();
}
</script>

{% endblock %}

