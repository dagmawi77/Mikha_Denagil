<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='plugins/pg-calendar/css/pignose.calendar.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='plugins/chartist/css/chartist.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='plugins/chartist-plugin-tooltips/css/chartist-plugin-tooltip.css') }}">
    <style>
        /* Debug Info */
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        
        /* Layout */
        .content {
            margin-left: 250px;
            transition: all 0.3s ease;
            padding: 15px;
        }
        .content.collapsed {
            margin-left: 80px;
        }
        
        /* Sidebar */
        .sidebar {
            height: 100vh;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #343a40;
            color: #fff;
            transition: all 0.3s ease;
            z-index: 100;
        }
        .sidebar.collapsed {
            width: 80px;
        }
        .sidebar .collapse-icon {
            position: absolute;
            top: 20px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
        }
        .sidebar .nav-link {
            color: #fff;
            text-decoration: none;
            display: block;
            padding: 10px;
            margin: 5px;
            transition: all 0.3s;
        }
        .sidebar .nav-link.active {
            background-color: #495057;
        }
        
        /* Charts */
        .chart-container {
            width: 100%;
            height: 300px;
            transition: all 0.3s ease;
        }
        .chart-wrapper {
            position: relative;
            min-height: 300px;
        }
        
        /* Animations */
        .counter {
            transition: all 0.5s ease-out;
            display: inline-block;
        }
        .counter-update {
            animation: pulse 0.8s ease-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .table-row-update {
            animation: highlight 1.2s ease-out;
        }
        @keyframes highlight {
            0% { background-color: rgba(255, 255, 0, 0.3); }
            100% { background-color: transparent; }
        }
        
        /* Tables */
        .compact-table {
            font-size: 0.9rem;
        }
        .compact-table th, 
        .compact-table td {
            padding: 0.5rem;
        }
        .no-data {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        /* Cards */
        .card-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        /* .card-body {
            padding: 1rem;
        } */
        
        /* Darkcyan tables */
        .darkcyan-table {
            background-color: darkcyan;
        }
        .darkcyan-table thead th {
            background-color: darkcyan;
            color: white;
        }
    </style>
</head>

<body>
    {% extends "base.html" %}

    {% block content %}


        <div class="container-fluid">
            <!-- Professional Dashboard CSS -->
            <style>
                /* Modern Dashboard Container */
                .dashboard-container {
                    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                    min-height: 100vh;
                    padding: 20px;
                }
                
                /* Enhanced Stat Cards */
                .stat-card {
                    border-radius: 20px;
                    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    border: none;
                    position: relative;
                    overflow: hidden;
                    min-height: 160px;
                    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
                    backdrop-filter: blur(10px);
                    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                }
                
                .stat-card:hover {
                    transform: translateY(-15px) scale(1.02);
                    box-shadow: 0 25px 50px rgba(0,0,0,0.25) !important;
                }
                
                .stat-card::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
                    pointer-events: none;
                }
                
                .stat-card::after {
                    content: '';
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    height: 4px;
                    background: linear-gradient(90deg, #14860C 0%, #106b09 100%);
                    transform: scaleX(0);
                    transition: transform 0.3s ease;
                }
                
                .stat-card:hover::after {
                    transform: scaleX(1);
                }
                
                /* Icon Styling */
                .stat-icon {
                    font-size: 3.5rem;
                    opacity: 0.15;
                    position: absolute;
                    right: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    transition: all 0.3s ease;
                }
                
                .stat-card:hover .stat-icon {
                    opacity: 0.25;
                    transform: translateY(-50%) scale(1.1) rotate(10deg);
                }
                
                /* Counter Number */
                .counter-number {
                    font-size: 3.5rem;
                    font-weight: 800;
                    background: linear-gradient(135deg, #14860C 0%, #106b09 100%);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    text-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    animation: countUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    display: inline-block;
                }
                
                @keyframes countUp {
                    from { 
                        transform: scale(0) rotate(-180deg); 
                        opacity: 0; 
                    }
                    to { 
                        transform: scale(1) rotate(0deg); 
                        opacity: 1; 
                    }
                }
                
                /* Card Title */
                .stat-card .card-title {
                    font-size: 1rem;
                    font-weight: 700;
                    color: #2c3e50 !important;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 1rem;
                }
                
                .card-subtitle {
                    font-size: 0.85rem;
                    color: #34495e !important;
                    font-weight: 600;
                }
                
                /* Professional Table Styling */
                .professional-table {
                    background: white;
                    border-radius: 15px;
                    overflow: hidden;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                }
                
                .professional-table .card-body {
                    padding: 2rem;
                }
                
                .professional-table table {
                    margin: 0;
                }
                
                .professional-table thead {
                    background: linear-gradient(135deg, #14860C 0%, #106b09 100%) !important;
                }
                
                .professional-table thead th {
                    color: white !important;
                    background: transparent !important;
                    font-weight: 600;
                    text-transform: uppercase;
                    font-size: 0.85rem;
                    letter-spacing: 0.5px;
                    padding: 1rem;
                    border: none;
                }
                
                .professional-table tbody tr {
                    transition: all 0.3s ease;
                    border-bottom: 1px solid #ecf0f1;
                }
                
                .professional-table tbody tr:hover {
                    background: linear-gradient(90deg, rgba(20, 134, 12, 0.05) 0%, rgba(20, 134, 12, 0.02) 100%);
                    transform: scale(1.01);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
                }
                
                .professional-table tbody td {
                    padding: 1rem;
                    color: #2c3e50;
                    font-weight: 500;
                    vertical-align: middle;
                }
                
                .professional-table tbody td:first-child {
                    font-weight: 700;
                    color: #14860C;
                }
                
                /* Section Header */
                .section-header {
                    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
                    backdrop-filter: blur(10px);
                    border-radius: 15px;
                    padding: 1.5rem;
                    margin-bottom: 2rem;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                    border-left: 5px solid #14860C;
                }
                
                .section-header h3 {
                    color: #14860C;
                    font-weight: 700;
                    margin: 0;
                    font-size: 1.5rem;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                }
                
                /* Chart Cards */
                .chart-card {
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                    transition: all 0.3s ease;
                    overflow: hidden;
                }
                
                .chart-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
                }
                
                .chart-card .card-title {
                    background: linear-gradient(135deg, #14860C 0%, #106b09 100%);
                    color: white;
                    padding: 1rem 1.5rem;
                    margin: 0;
                    font-weight: 600;
                    font-size: 1.1rem;
                }
                
                /* Responsive Adjustments */
                @media (max-width: 1200px) {
                    .counter-number {
                        font-size: 2.5rem;
                    }
                    .stat-icon {
                        font-size: 2.5rem;
                    }
                }
                
                @media (max-width: 768px) {
                    .stat-card {
                        min-height: 140px;
                        margin-bottom: 1rem;
                    }
                    .counter-number {
                        font-size: 2rem;
                    }
                }
                
                /* Loading Animation */
                .loading-shimmer {
                    animation: shimmer 2s infinite;
                    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                    background-size: 200% 100%;
                }
                
                @keyframes shimmer {
                    0% { background-position: -200% 0; }
                    100% { background-position: 200% 0; }
                }
            </style>
            
            <div class="row g-3">
                <!-- All 5 Cards in One Row - Interactive & Attractive -->
                <!-- Card 1: Total Members -->
                <div class="col-xl col-lg-4 col-md-6 col-sm-12">
                    <div class="card gradient-1 h-100 shadow-lg stat-card">
                        <i class="fa fa-users stat-icon" style="color: #14860C;"></i>
                        <div class="card-body p-4">
                            <div class="text-center">
                                <h5 class="card-title mb-3 font-weight-bold">የአባላት ብዛት</h5>
                                <div class="counter-number mb-2" id="current-bill-count">{{ current_bill_count }}</div>
                                <p class="mb-0 card-subtitle" id="bill-period">{{bill_period}}</p>
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- Card 2: Middle Section -->
                <div class="col-xl col-lg-4 col-md-6 col-sm-12">
                    <div class="card gradient-2 h-100 shadow-lg stat-card">
                        <i class="fa fa-user-circle stat-icon" style="color: #14860C;"></i>
                        <div class="card-body p-4">
                            <div class="text-center">
                                <h5 class="card-title mb-3 font-weight-bold">ማህከላዊያን ክፍል</h5>
                                <div class="counter-number mb-2" id="current-month-total-bill-amnt">{{current_month_total_bill_amnt}}</div>
                                <p class="mb-0 card-subtitle">ክፍል: ማህከላዊያን ክፍል</p>
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- Card 3: Children Section -->
                <div class="col-xl col-lg-4 col-md-6 col-sm-12">
                    <div class="card gradient-3 h-100 shadow-lg stat-card">
                        <i class="fa fa-child stat-icon" style="color: #14860C;"></i>
                        <div class="card-body p-4">
                            <div class="text-center">
                                <h5 class="card-title mb-3 font-weight-bold">የሕፃናት ክፍል</h5>
                                <div class="counter-number mb-2" id="payment-count">{{payment_count}}</div>
                                <p class="mb-0 card-subtitle">ክፍል: የሕፃናት ክፍል</p>
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- Card 4: Youth Section -->
                <div class="col-xl col-lg-4 col-md-6 col-sm-12">
                    <div class="card gradient-4 h-100 shadow-lg stat-card">
                        <i class="fa fa-graduation-cap stat-icon" style="color: #14860C;"></i>
                        <div class="card-body p-4">
                            <div class="text-center">
                                <h5 class="card-title mb-3 font-weight-bold">ወጣት ክፍል</h5>
                                <div class="counter-number mb-2" id="payment-total-bill-amnt">{{payment_total_bill_amnt}}</div>
                                <p class="mb-0 card-subtitle">ክፍል: ወጣት ክፍል</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Card 5: Parent Section -->
                <div class="col-xl col-lg-4 col-md-6 col-sm-12">
                    <div class="card gradient-1 h-100 shadow-lg stat-card">
                        <i class="fa fa-heart stat-icon" style="color: #14860C;"></i>
                        <div class="card-body p-4">
                            <div class="text-center">
                                <h5 class="card-title mb-3 font-weight-bold">ወላጅ ክፍል</h5>
                                <div class="counter-number mb-2" id="parent-section-count">{{parent_section_count}}</div>
                                <p class="mb-0 card-subtitle">ክፍል: ወላጅ ክፍል</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

            <!-- Charts Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="section-header">
                        <h3><i class="fa fa-pie-chart me-2"></i>Statistical Analysis - ስታትስቲክስ ትንታኔ</h3>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3 g-3">
                <div class="col-lg-6">
                    <div class="card chart-card h-100">
                        <h4 class="card-title">
                            <span style="white-space: nowrap;">አባላት በክፍል - Members by Section</span>
                        </h4>
                        <div class="card-body">
                            <div class="chart-wrapper">
                                <div class="chart-container">
                                    <canvas id="paymentChannelChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="card chart-card h-100">
                        <h4 class="card-title">
                            <span style="white-space: nowrap;">የአባላት ግራፍ በፃታ - Gender Distribution</span>
                        </h4>
                        <div class="card-body">
                            <div class="chart-wrapper">
                                <div class="chart-container">
                                    <canvas id="branch-sent-data-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Header with Export Button -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"><i class="fa fa-bar-chart me-2"></i>አጠቃላይ ሪፖርት - Summary Report</h3>
                        <button onclick="exportDashboardToPDF()" class="btn btn-success" style="background: linear-gradient(135deg, #14860C 0%, #106b09 100%); border: none; padding: 10px 25px; border-radius: 10px; font-weight: 600; box-shadow: 0 4px 15px rgba(20, 134, 12, 0.3); transition: all 0.3s ease;">
                            <i class="fa fa-file-pdf-o me-2"></i>Export to PDF
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Professional Summary Table -->
            <div class="row g-3">
                <div class="col-12">
                    <div class="card professional-table">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped compact-table">
                                    <thead>
                                        <tr>
                                            <th>ክፍል</th>
                                            <th>ወንድ</th>
                                            <th>ሴት</th>
                                            <th>ያላገባ</th>
                                            <th>ያገባ</th>
                                            <th>በሥራ ላይ</th>
                                            <th>ስራ የለኝም</th>
                                            <th>በመፈለግ ላይ</th>
                                            <th>ተማሪ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="settledTableBody">
                                        {% for bill in current_settled %}
                                        <tr>
                                            <td><b>{{ bill[0] }}</b></td>
                                            <td>{{ bill[1] }}</td>
                                            <td>{{ bill[2] }}</td>
                                            <td>{{ bill[3] }}</td>
                                            <td><b>{{ bill[4] }}</b></td>
                                            <td><b>{{ bill[5] }}</b></td>
                                            <td><b>{{ bill[6] }}</b></td>
                                            <td><b>{{ bill[7] }}</b></td>
                                            <td><b>{{ bill[8] }}</b></td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="9" class="no-data">No data available</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    <div class="footer">
        <div class="copyright">
            <p>Copyright &copy; Designed & Developed by Dagmawi Letarik 2025</p>
        </div>
    </div>

    <script>
        // Global variables
        let branchSentDataChart;
        let paymentChannelChart;
        let isUpdating = false;
        let updateInterval;
        let lastData = {};
        
        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
            
            // Resize charts after transition
            setTimeout(() => {
                if (branchSentDataChart) branchSentDataChart.resize();
                if (paymentChannelChart) paymentChannelChart.resize();
            }, 300);
        }

        // Enhanced number formatter
        function formatNumber(value) {
            if (value === null || value === undefined) return '0';
            if (typeof value === 'string') {
                if (value.includes(',')) return value;
                value = parseFloat(value);
            }
            return value.toLocaleString('en-US');
        }

        // Improved counter animation
        function animateValue(id, newValue) {
            const element = document.getElementById(id);
            if (!element || newValue === undefined || newValue === null) return;
            
            const formattedValue = formatNumber(newValue);
            const currentText = element.textContent.trim();
            
            if (currentText === formattedValue) return;
            
            element.classList.remove('counter-update');
            void element.offsetWidth;
            
            element.classList.add('counter-update');
            element.textContent = formattedValue;
        }

        // Table updater with null checks
        function updateTable(tableId, rows) {
            const tbody = document.getElementById(tableId);
            if (!tbody) return;
            
            // Determine column count based on table ID
            const isSettledTable = tableId === 'settledTableBody';
            const colSpan = isSettledTable ? 9 : 7;
            
            if (!rows || !Array.isArray(rows) || rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="no-data">No data available</td></tr>`;
                return;
            }
            
            let newRowsHTML = '';
            rows.forEach(row => {
                if (!row) return;
                
                if (isSettledTable && row.length >= 9) {
                    // Summary report table (አጠቃላይ ሪፖርት) - 9 columns
                    newRowsHTML += `
                    <tr class="table-row-update">
                        <td><b>${row[0] || 'N/A'}</b></td>
                        <td>${row[1] || '0'}</td>
                        <td>${row[2] || '0'}</td>
                        <td>${row[3] || '0'}</td>
                        <td><b>${row[4] || '0'}</b></td>
                        <td><b>${row[5] || '0'}</b></td>
                        <td><b>${row[6] || '0'}</b></td>
                        <td><b>${row[7] || '0'}</b></td>
                        <td><b>${row[8] || '0'}</b></td>
                    </tr>`;
                } else if (!isSettledTable && row.length >= 7) {
                    // Other tables - 7 columns
                    newRowsHTML += `
                    <tr class="table-row-update">
                        <td>${row[0] || 'N/A'}</td>
                        <td>${row[1] || 'N/A'}</td>
                        <td>${row[2] || '0'}</td>
                        <td>${row[3] || '0'}</td>
                        <td><b>${formatNumber(row[4])}</b></td>
                        <td><b>${formatNumber(row[5])}</b></td>
                        <td><b>${formatNumber(row[6])}</b></td>
                    </tr>`;
                }
            });
            
            if (newRowsHTML && tbody.innerHTML !== newRowsHTML) {
                tbody.innerHTML = newRowsHTML;
            } else if (!newRowsHTML) {
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="no-data">No data available</td></tr>`;
            }
        }

        // Data fetcher with validation
        async function fetchData() {
            if (isUpdating) return;
            isUpdating = true;
            
            try {
                const response = await fetch('/dashboard-data');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                lastData = data;
                console.log('Data received:', data);
                
                // Update Paid Bills/Amount
                if (data.payment_count !== undefined) {
                    animateValue('payment-count', data.payment_count);
                }
                if (data.payment_total_bill_amnt !== undefined) {
                    animateValue('payment-total-bill-amnt', data.payment_total_bill_amnt);
                }
                if (data.payment_month !== undefined) {
                    const paymentMonthEl = document.getElementById('payment-month');
                    if (paymentMonthEl) {
                        paymentMonthEl.textContent = data.payment_month;
                    }
                }
                if (data.payment_this_month_bill_amnt !== undefined) {
                    const paymentThisMonthEl = document.getElementById('payment-this-month-bill-amnt');
                    if (paymentThisMonthEl) {
                        paymentThisMonthEl.textContent = formatNumber(data.payment_this_month_bill_amnt);
                    }
                }
                
                // Update other counters
                if (data.current_bill_count !== undefined) {
                    animateValue('current-bill-count', data.current_bill_count);
                }
                if (data.bill_period !== undefined) {
                    const billPeriodEl = document.getElementById('bill-period');
                    if (billPeriodEl) {
                        billPeriodEl.textContent = data.bill_period;
                    }
                }
                if (data.current_month_total_bill_amnt !== undefined) {
                    animateValue('current-month-total-bill-amnt', data.current_month_total_bill_amnt);
                }
                if (data.current_month_bill_amnt !== undefined) {
                    const currentMonthBillEl = document.getElementById('current-month-bill-amnt');
                    if (currentMonthBillEl) {
                        currentMonthBillEl.textContent = formatNumber(data.current_month_bill_amnt);
                    }
                }
                
                // Update parent section count (Card 5)
                if (data.parent_section_count !== undefined) {
                    const parentElement = document.getElementById('parent-section-count');
                    if (parentElement) {
                        animateValue('parent-section-count', data.parent_section_count);
                    }
                }
                
                // Update tables - Debug logging
                console.log('Updating summary table with data:', data.current_settled);
                if (data.current_settled && data.current_settled.length > 0) {
                    updateTable('settledTableBody', data.current_settled);
                } else {
                    console.warn('No summary data received, keeping existing data');
                    // Don't clear the table if no data is received
                }
                updateTable('deliveryTableBody', data.current_delivery || []);
                updateTable('unsettledTableBody', data.current_unsettled || []);
                
                // Update charts
                if (data.branch_labels && data.number_sent_data) {
                    updateCharts(data);
                }
                
            } catch (error) {
                console.error('Failed to fetch data:', error);
                updateTable('settledTableBody', []);
                updateTable('deliveryTableBody', []);
                updateTable('unsettledTableBody', []);
            } finally {
                isUpdating = false;
            }
        }

        // Chart updater
        function updateCharts(data) {
            // Branch Sent Data Chart
            const branchCtx = document.getElementById('branch-sent-data-chart');
            if (!branchSentDataChart) {
                branchSentDataChart = new Chart(branchCtx, {
                    type: 'bar',
                    data: {
                        labels: data.branch_labels,
                        datasets: [
                            {
                                label: 'ወንድ',
                                data: data.number_sent_data,
                                backgroundColor: '#FFCE56',
                                stack: 'Stack 1'
                            },
                            {
                                label: 'ሴት',
                                data: data.total_amount_sent_data,
                                backgroundColor: '#4BC0C0',
                                stack: 'Stack 1'
                            },
                            {
                                label: 'Outstanding Amount',
                                data: data.outstanding_amount,
                                backgroundColor: '#45265',
                                stack: 'Stack 3'
                            },
                            {
                                label: 'Current Bill amount',
                                data: data.this_month_bill_amnt,
                                backgroundColor: '#FF1156',
                                stack: 'Stack 4'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        animation: {
                            duration: 1000,
                            onComplete: () => {
                                if (this.resize) this.resize();
                            }
                        }
                    }
                });
            } else {
                branchSentDataChart.data.labels = data.branch_labels;
                branchSentDataChart.data.datasets[0].data = data.number_sent_data;
                branchSentDataChart.data.datasets[1].data = data.total_amount_sent_data;
                branchSentDataChart.data.datasets[2].data = data.outstanding_amount;
                branchSentDataChart.data.datasets[3].data = data.this_month_bill_amnt;
                branchSentDataChart.update();
            }

            // Payment Channel Chart
            const paymentCtx = document.getElementById('paymentChannelChart');
            if (!paymentChannelChart) {
                paymentChannelChart = new Chart(paymentCtx, {
                    type: 'pie',
                    data: {
                        labels: data.channel_labels,
                        datasets: [{
                            data: data.channel_amounts,
                            backgroundColor: [
                                'rgba(20, 134, 12, 0.8)',  // Green
                                'rgba(54, 162, 235, 0.8)', // Blue
                                'rgba(255, 206, 86, 0.8)', // Yellow
                                'rgba(255, 99, 132, 0.8)', // Red
                                'rgba(153, 102, 255, 0.8)', // Purple
                                'rgba(255, 159, 64, 0.8)'  // Orange
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 13,
                                        weight: 'bold'
                                    },
                                    padding: 15,
                                    generateLabels: function(chart) {
                                        const chartData = chart.data;
                                        if (chartData.labels.length && chartData.datasets.length) {
                                            return chartData.labels.map((label, i) => {
                                                const value = chartData.datasets[0].data[i];
                                                return {
                                                    text: `${label}: ${value}`,
                                                    fillStyle: chartData.datasets[0].backgroundColor[i],
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        return `${label}: ${value} አባላት`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true
                        }
                    }
                });
            } else {
                paymentChannelChart.data.labels = data.channel_labels;
                paymentChannelChart.data.datasets[0].data = data.channel_amounts;
                paymentChannelChart.update();
            }
        }

        // PDF Export Function - Full Dashboard Screenshot
        async function exportDashboardToPDF() {
            const exportBtn = event.target.closest('button');
            const originalHTML = exportBtn.innerHTML;
            exportBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Generating PDF...';
            exportBtn.disabled = true;
            
            try {
                // Get the entire dashboard container
                const dashboardElement = document.querySelector('.container-fluid');
                
                // Temporarily hide the export button
                exportBtn.style.display = 'none';
                
                // Use html2canvas to capture the dashboard
                const canvas = await html2canvas(dashboardElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    windowWidth: dashboardElement.scrollWidth,
                    windowHeight: dashboardElement.scrollHeight
                });
                
                // Show button again
                exportBtn.style.display = '';
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Create PDF with landscape if needed
                const orientation = imgHeight > 297 ? 'portrait' : 'portrait';
                const pdf = new jsPDF(orientation, 'mm', 'a4');
                
                // Add image to PDF
                const imgData = canvas.toDataURL('image/png');
                
                if (imgHeight > 297) {
                    // Multiple pages needed
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= 297;
                    
                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= 297;
                    }
                } else {
                    // Single page
                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                }
                
                // Save PDF
                const fileName = `Mikha_Denagil_Dashboard_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                // Success message
                alert('✅ Dashboard exported successfully!\nFile: ' + fileName);
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('❌ Error exporting PDF: ' + error.message);
            } finally {
                exportBtn.innerHTML = originalHTML;
                exportBtn.disabled = false;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📊 Initializing charts...');
            // Initialize charts with template data
            branchSentDataChart = new Chart(
                document.getElementById('branch-sent-data-chart'),
                {
                    type: 'bar',
                    data: {
                        labels: {{ branch_labels | tojson }},
                        datasets: [
                            {
                                label: 'ወንድ',
                                data: {{ number_sent_data | tojson }},
                                backgroundColor: '#FFCE56',
                                stack: 'Stack 1'
                            },
                            {
                                label: 'ሴት',
                                data: {{ total_amount_sent_data | tojson }},
                                backgroundColor: '#4BC0C0',
                                stack: 'Stack 1'
                            },
                            {
                                label: '',
                                data: {{ outstanding_amount | tojson }},
                                backgroundColor: '#45265',
                                stack: 'Stack 3'
                            },
                            {
                                label: '',
                                data: {{ this_month_bill_amnt | tojson }},
                                backgroundColor: '#FF1156',
                                stack: 'Stack 4'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        }
                    }
                }
            );

            // Debug chart data
            const chartLabels = {{ channel_labels | tojson }};
            const chartAmounts = {{ channel_amounts | tojson }};
            const branchLabels = {{ branch_labels | tojson }};
            const maleData = {{ number_sent_data | tojson }};
            const femaleData = {{ total_amount_sent_data | tojson }};
            
            console.log('=== CHART INITIALIZATION DATA ===');
            console.log('Pie Chart - Labels:', chartLabels);
            console.log('Pie Chart - Amounts:', chartAmounts);
            console.log('Bar Chart - Branch Labels:', branchLabels);
            console.log('Bar Chart - Male Data:', maleData);
            console.log('Bar Chart - Female Data:', femaleData);
            console.log('================================');
            
            paymentChannelChart = new Chart(
                document.getElementById('paymentChannelChart'),
                {
                    type: 'pie',
                    data: {
                        labels: {{ channel_labels | tojson }},
                        datasets: [{
                            data: {{ channel_amounts | tojson }},
                            backgroundColor: [
                                'rgba(20, 134, 12, 0.8)',  // Green
                                'rgba(54, 162, 235, 0.8)', // Blue
                                'rgba(255, 206, 86, 0.8)', // Yellow
                                'rgba(255, 99, 132, 0.8)', // Red
                                'rgba(153, 102, 255, 0.8)', // Purple
                                'rgba(255, 159, 64, 0.8)'  // Orange
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 13,
                                        weight: 'bold'
                                    },
                                    padding: 15,
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const value = data.datasets[0].data[i];
                                                return {
                                                    text: `${label}: ${value}`,
                                                    fillStyle: data.datasets[0].backgroundColor[i],
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        return `${label}: ${value} አባላት`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true
                        }
                    }
                }
            );

            // Start periodic updates (every 20 seconds)
            updateInterval = setInterval(fetchData, 20000);
            
            // Initial data fetch
            fetchData();
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            clearInterval(updateInterval);
        });
    </script>
    {% endblock %}
</body>
</html>