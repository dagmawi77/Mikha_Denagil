{% extends "base.html" %}

{% block content %}
<style>
    .pos-container { background: #f8f9fa; min-height: 100vh; padding: 30px; }
    .page-header { background: linear-gradient(135deg, #14860C 0%, #106b09 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; }
    .page-header h2 { margin: 0; font-size: 32px; font-weight: 700; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #14860C; }
    .stat-card .value { font-size: 32px; font-weight: 700; color: #2c3e50; }
    .stat-card .label { font-size: 14px; color: #6c757d; font-weight: 600; }
    .modern-card { background: white; border-radius: 15px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); margin-bottom: 30px; }
    .modern-card .card-header { background: linear-gradient(135deg, #14860C 0%, #106b09 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
    .modern-card .card-body { padding: 30px; }
    .form-control { border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; }
    .btn-create { background: linear-gradient(135deg, #14860C 0%, #106b09 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-weight: 600; }
    .btn-template { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; }
    .btn-clone { background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; }
    .professional-table thead th { background: linear-gradient(135deg, #14860C 0%, #106b09 100%); color: white !important; padding: 15px; font-weight: 600; }
    .professional-table tbody td { padding: 12px; border-bottom: 1px solid #e9ecef; }
    .btn-delete { background: #dc3545; color: white; padding: 6px 15px; border-radius: 6px; border: none; }
    .btn-edit { background: #ffc107; color: #212529; padding: 6px 15px; border-radius: 6px; border: none; }
    .template-card { border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 15px; transition: all 0.3s; }
    .template-card:hover { border-color: #14860C; box-shadow: 0 4px 12px rgba(20, 134, 12, 0.15); }
    .template-card.selected { border-color: #14860C; background: #f8fff8; }
    .template-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .template-title { font-weight: 600; color: #2c3e50; }
    .template-category { background: #14860C; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    .template-details { font-size: 14px; color: #6c757d; }
    .template-usage { font-size: 12px; color: #14860C; font-weight: 600; }
    .tab-container { margin-bottom: 30px; }
    .tab-buttons { display: flex; background: white; border-radius: 10px; padding: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    .tab-button { flex: 1; padding: 12px 20px; border: none; background: transparent; border-radius: 8px; font-weight: 600; transition: all 0.3s; }
    .tab-button.active { background: linear-gradient(135deg, #14860C 0%, #106b09 100%); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .checkbox-container { display: flex; align-items: center; margin-bottom: 10px; }
    .checkbox-container input[type="checkbox"] { margin-right: 8px; }
    .leadership-badge { background: #ffc107; color: #212529; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .position-type-badge { background: #17a2b8; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .holders-info { font-size: 12px; color: #6c757d; }
    .reports-to { font-size: 12px; color: #14860C; font-style: italic; }
</style>

<div class="pos-container">
    <div class="page-header">
        <h2><i class="icon-badge"></i> Dynamic Position Management / የሥራ መደብ አስተዳደር</h2>
        <p>Create, manage, and organize job positions with templates and dynamic features</p>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}{% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show">{{ message }}<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button></div>
            {% endfor %}{% endif %}
    {% endwith %}
    
    <div class="stats-row">
        <div class="stat-card">
            <div class="label">Total Positions</div>
            <div class="value">{{ stats[0] or 0 }}</div>
        </div>
        <div class="stat-card">
            <div class="label">Active Positions</div>
            <div class="value">{{ stats[1] or 0 }}</div>
        </div>
        <div class="stat-card">
            <div class="label">Leadership Positions</div>
            <div class="value">{{ stats[3] or 0 }}</div>
        </div>
        <div class="stat-card">
            <div class="label">Available Templates</div>
            <div class="value">{{ stats[4] or 0 }}</div>
        </div>
    </div>
    
    <!-- Tab Container -->
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('manual')">
                <i class="icon-plus"></i> Manual Creation
            </button>
            <button class="tab-button" onclick="showTab('templates')">
                <i class="icon-layers"></i> From Templates
            </button>
            <button class="tab-button" onclick="showTab('bulk')">
                <i class="icon-grid"></i> Bulk Creation
            </button>
            <button class="tab-button" onclick="showTab('clone')">
                <i class="icon-copy"></i> Clone Position
            </button>
        </div>
        
        <!-- Manual Creation Tab -->
        <div id="manual" class="tab-content active">
            <div class="modern-card">
                <div class="card-header">
                    <h4><i class="icon-plus"></i> Create New Position</h4>
                    <button class="btn btn-sm btn-light" onclick="toggleForm('manualForm')" id="manualToggleBtn"><i class="icon-arrow-down"></i> Collapse</button>
                </div>
                <div class="card-body" id="manualForm">
                    <form method="POST">
                        <input type="hidden" name="action" value="create">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Position Title *</label>
                                    <input type="text" class="form-control" name="position_title" placeholder="e.g., Treasurer, Youth Leader" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Department</label>
                                    <select class="form-control" name="department_id">
                                        <option value="">-- Select Department --</option>
                                        {% for dept in departments %}
                                            <option value="{{ dept[0] }}">{{ dept[1] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Position Level</label>
                                    <select class="form-control" name="position_level">
                                        <option value="">-- Select Level --</option>
                                        <option value="Executive">Executive</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Coordinator">Coordinator</option>
                                        <option value="Staff">Staff</option>
                                        <option value="Volunteer">Volunteer</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Position Type</label>
                                    <select class="form-control" name="position_type">
                                        <option value="Regular">Regular</option>
                                        <option value="Temporary">Temporary</option>
                                        <option value="Contract">Contract</option>
                                        <option value="Volunteer">Volunteer</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Reports To</label>
                                    <select class="form-control" name="reporting_to">
                                        <option value="">-- Select Reporting Position --</option>
                                        {% for pos in reporting_positions %}
                                            <option value="{{ pos[0] }}">{{ pos[1] }} ({{ pos[3] or 'No Department' }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Max Holders</label>
                                    <input type="number" class="form-control" name="max_holders" value="1" min="1">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Min Experience (Years)</label>
                                    <input type="number" class="form-control" name="min_experience_years" value="0" min="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Salary Range (Optional)</label>
                                    <input type="text" class="form-control" name="salary_range" placeholder="e.g., $30,000 - $40,000">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="checkbox-container">
                                    <input type="checkbox" name="is_leadership" id="is_leadership">
                                    <label for="is_leadership">This is a leadership position</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>Responsibilities</label>
                                    <textarea class="form-control" name="responsibilities" rows="3" placeholder="Job responsibilities and duties"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>Required Skills</label>
                                    <textarea class="form-control" name="required_skills" rows="2" placeholder="Required skills and qualifications"></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-create"><i class="icon-plus"></i> Create Position</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Templates Tab -->
        <div id="templates" class="tab-content">
            <div class="modern-card">
                <div class="card-header">
                    <h4><i class="icon-layers"></i> Create from Template</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Select Department</label>
                                <select class="form-control" id="templateDept">
                                    <option value="">-- Select Department --</option>
                                    {% for dept in departments %}
                                        <option value="{{ dept[0] }}">{{ dept[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <h5>Available Templates:</h5>
                    <div class="row">
                        {% for template in templates %}
                        <div class="col-md-6 col-lg-4">
                            <div class="template-card" onclick="selectTemplate({{ template[0] }})">
                                <div class="template-header">
                                    <div class="template-title">{{ template[3] }}</div>
                                    <div class="template-category">{{ template[2] }}</div>
                                </div>
                                <div class="template-details">
                                    <strong>Level:</strong> {{ template[4] }}<br>
                                    <strong>Type:</strong> {{ template[6] }}<br>
                                    {% if template[7] %}<span class="leadership-badge">Leadership</span>{% endif %}
                                    <br><strong>Max Holders:</strong> {{ template[8] }}<br>
                                    <strong>Min Experience:</strong> {{ template[9] }} years
                                </div>
                                <div class="template-usage">Used {{ template[12] }} times</div>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-template btn-sm" onclick="createFromTemplate({{ template[0] }})">
                                        <i class="icon-plus"></i> Create Position
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bulk Creation Tab -->
        <div id="bulk" class="tab-content">
            <div class="modern-card">
                <div class="card-header">
                    <h4><i class="icon-grid"></i> Bulk Position Creation</h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="bulkForm">
                        <input type="hidden" name="action" value="bulk_create">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Select Department</label>
                                    <select class="form-control" name="department_id" required>
                                        <option value="">-- Select Department --</option>
                                        {% for dept in departments %}
                                            <option value="{{ dept[0] }}">{{ dept[1] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <h5>Select Templates to Create:</h5>
                        <div class="row">
                            {% for template in templates %}
                            <div class="col-md-6 col-lg-4">
                                <div class="checkbox-container">
                                    <input type="checkbox" name="template_ids" value="{{ template[0] }}" id="bulk_{{ template[0] }}">
                                    <label for="bulk_{{ template[0] }}">
                                        <strong>{{ template[3] }}</strong> ({{ template[2] }}) - {{ template[4] }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <button type="submit" class="btn btn-create" onclick="return confirmBulkCreate()">
                            <i class="icon-plus"></i> Create Selected Positions
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Clone Position Tab -->
        <div id="clone" class="tab-content">
            <div class="modern-card">
                <div class="card-header">
                    <h4><i class="icon-copy"></i> Clone Existing Position</h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="action" value="clone">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Select Position to Clone</label>
                                    <select class="form-control" name="source_position_id" required>
                                        <option value="">-- Select Position --</option>
                                        {% for pos in positions %}
                                            <option value="{{ pos[0] }}">{{ pos[1] }} ({{ pos[3] or 'No Department' }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>New Position Title</label>
                                    <input type="text" class="form-control" name="new_title" placeholder="Enter new position title" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Assign to Department</label>
                                    <select class="form-control" name="department_id">
                                        <option value="">-- Select Department --</option>
                                        {% for dept in departments %}
                                            <option value="{{ dept[0] }}">{{ dept[1] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-clone">
                            <i class="icon-copy"></i> Clone Position
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Positions List -->
    <div class="modern-card">
        <div class="card-header"><h4><i class="icon-list"></i> All Positions ({{ positions|length }})</h4></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="professional-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Department</th>
                            <th>Level</th>
                            <th>Type</th>
                            <th>Holders</th>
                            <th>Reports To</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pos in positions %}
                        <tr>
                            <td>
                                <strong>{{ pos[1] }}</strong>
                                {% if pos[8] %}<span class="leadership-badge">Leadership</span>{% endif %}
                                <br><small class="holders-info">{{ pos[15] }}/{{ pos[9] }} holders</small>
                            </td>
                            <td>{{ pos[3] or '-' }}</td>
                            <td>{{ pos[4] or '-' }}</td>
                            <td><span class="position-type-badge">{{ pos[7] or 'Regular' }}</span></td>
                            <td>{{ pos[15] }}/{{ pos[9] }}</td>
                            <td>
                                {% if pos[16] %}
                                    <span class="reports-to">{{ pos[16] }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if pos[13] == 'Active' %}
                                    <span class="badge badge-success">Active</span>
                                {% else %}
                                    <span class="badge badge-secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn-action btn-edit" onclick="editPosition({{ pos[0] }})" title="Edit">
                                    <i class="icon-pencil"></i>
                                </button>
                                <form method="POST" style="display: inline;">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="position_id" value="{{ pos[0] }}">
                                    <button type="submit" class="btn-action btn-delete" onclick="return confirm('Delete position?')" title="Delete">
                                        <i class="icon-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function showTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tabName).classList.add('active');
        
        // Add active class to clicked button
        event.target.classList.add('active');
    }
    
    function toggleForm(formId) {
        const form = document.getElementById(formId);
        const btn = document.getElementById(formId.replace('Form', 'ToggleBtn'));
        if (form.style.display === 'none') {
            form.style.display = 'block';
            btn.innerHTML = '<i class="icon-arrow-down"></i> Collapse';
        } else {
            form.style.display = 'none';
            btn.innerHTML = '<i class="icon-arrow-up"></i> Expand';
        }
    }
    
    function selectTemplate(templateId) {
        // Remove previous selection
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Add selection to clicked card
        event.currentTarget.classList.add('selected');
    }
    
    function createFromTemplate(templateId) {
        const departmentId = document.getElementById('templateDept').value;
        if (!departmentId) {
            alert('Please select a department first');
            return;
        }
        
        if (confirm('Create position from this template?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.innerHTML = `
                <input type="hidden" name="action" value="create_from_template">
                <input type="hidden" name="template_id" value="${templateId}">
                <input type="hidden" name="department_id" value="${departmentId}">
            `;
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    function confirmBulkCreate() {
        const checkboxes = document.querySelectorAll('input[name="template_ids"]:checked');
        if (checkboxes.length === 0) {
            alert('Please select at least one template');
            return false;
        }
        return confirm(`Create ${checkboxes.length} positions from selected templates?`);
    }
    
    function editPosition(positionId) {
        // This would open an edit modal or redirect to edit page
        alert('Edit functionality will be implemented in the next update');
    }
</script>
{% endblock %}