{% extends "base.html" %}

{% block title %}Attendance Report - ·ã®·ä†·â¥·äï·ã≥·äï·àµ ·à™·çñ·à≠·âµ{% endblock %}

{% block content %}
<style>
    .report-header {
        background: linear-gradient(135deg, #14860C 0%, #106b09 100%);
        color: white;
        padding: 2.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(20, 134, 12, 0.2);
    }
    
    .filter-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }
    
    .report-table-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .table-header {
        background: linear-gradient(135deg, #14860C 0%, #106b09 100%);
        color: white;
        padding: 1.5rem;
    }
    
    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .present { background: #d4edda; color: #155724; }
    .absent { background: #f8d7da; color: #721c24; }
    .sick { background: #fff3cd; color: #856404; }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="report-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-2"><i class="fa fa-file-text me-3"></i>·ã®·ä†·â¥·äï·ã≥·äï·àµ ·à™·çñ·à≠·âµ - Attendance Report</h2>
                <p class="mb-0" style="opacity: 0.9;">View, filter, and export attendance records</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                    <a href="?{{ request.query_string.decode() }}&format=excel" class="btn btn-light" style="border-radius: 10px 0 0 10px;">
                        <i class="fa fa-file-excel-o me-2"></i>Excel
                    </a>
                    <a href="?{{ request.query_string.decode() }}&format=pdf" class="btn btn-light">
                        <i class="fa fa-file-pdf-o me-2"></i>PDF
                    </a>
                    <a href="?{{ request.query_string.decode() }}&format=csv" class="btn btn-light" style="border-radius: 0 10px 10px 0;">
                        <i class="fa fa-file-code-o me-2"></i>CSV
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stat-number" style="color: #14860C;">{{ total }}</div>
                <div class="stat-label">Total Records<br>·å†·âÖ·àã·àã ·àò·ãù·åà·â¶·âΩ</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stat-number" style="color: #28a745;">
                    {{ payments|selectattr('6', 'equalto', 'Present')|list|length if payments else 0 }}
                </div>
                <div class="stat-label">Present<br>·ã®·äê·â†·à©</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stat-number" style="color: #dc3545;">
                    {{ payments|selectattr('6', 'equalto', 'Absent')|list|length if payments else 0 }}
                </div>
                <div class="stat-label">Absent<br>·ã´·àç·äê·â†·à©</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stat-number" style="color: #ffc107;">
                    {{ payments|selectattr('6', 'equalto', 'Sick')|list|length if payments else 0 }}
                </div>
                <div class="stat-label">Sick<br>·â†·àΩ·â∞·äû·âΩ</div>
            </div>
        </div>
    </div>
    
    <!-- Advanced Filters -->
    <div class="filter-card">
        <h4 class="mb-3" style="color: #14860C; font-weight: 700;">
            <i class="fa fa-filter me-2"></i>Advanced Filters - ·ã®·àã·âÄ ·àõ·å£·à™·ã´
        </h4>
        
        <form method="GET" action="{{ url_for('attendance_report') }}">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Search by Name or Phone</label>
                    <input type="text" name="search" class="form-control" value="{{ search_query }}" placeholder="üîç ·â†·àµ·àù ·ãà·ã≠·àù ·àµ·àç·ä≠ ·çà·àç·åç">
                </div>
                
                <div class="col-md-3">
                    <label class="form-label fw-bold">Filter by Section</label>
                    <select name="branch" class="form-select">
                        <option value="All" {% if selected_branch == 'All' %}selected{% endif %}>All Sections</option>
                        {% for branch in branches %}
                        <option value="{{ branch }}" {% if selected_branch == branch %}selected{% endif %}>{{ branch }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label fw-bold">Start Date</label>
                    <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                
                <div class="col-md-2">
                    <label class="form-label fw-bold">End Date</label>
                    <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>
                
                <div class="col-md-2">
                    <label class="form-label fw-bold">&nbsp;</label>
                    <button type="submit" class="btn btn-success w-100" style="background: linear-gradient(135deg, #14860C 0%, #106b09 100%); border: none; border-radius: 10px; font-weight: 600;">
                        <i class="fa fa-search me-2"></i>Filter
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Attendance Records Table -->
    <div class="report-table-card">
        <div class="table-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0"><i class="fa fa-table me-2"></i>Attendance Records - ·ã®·àò·åà·äò·âµ ·àò·ãù·åà·â¶·âΩ</h4>
                </div>
                <div class="col-md-6 text-end">
                    <span class="badge bg-light text-dark" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                        Showing {{ payments|length }} of {{ total }} records
                    </span>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Full Name<br>·àô·àâ ·àµ·àù</th>
                        <th>Gender<br>·çÜ·â≥</th>
                        <th>Christian Name<br>·ä≠·à≠·àµ·âµ·äì ·àµ·àù</th>
                        <th>Phone<br>·àµ·àç·ä≠</th>
                        <th>Section<br>·ä≠·çç·àç</th>
                        <th>Date<br>·âÄ·äï</th>
                        <th>Status<br>·àÅ·äî·â≥</th>
                    </tr>
                </thead>
                <tbody>
                    {% if payments %}
                        {% for record in payments %}
                        <tr>
                            <td><strong>{{ record[0] }}</strong></td>
                            <td>
                                <span class="badge {% if record[1] == '·ãà·äï·ãµ' %}bg-info{% else %}bg-danger{% endif %}">
                                    {{ record[1] }}
                                </span>
                            </td>
                            <td>{{ record[2] or '-' }}</td>
                            <td>{{ record[3] or '-' }}</td>
                            <td><span class="badge bg-success">{{ record[4] }}</span></td>
                            <td>{{ record[5] }}</td>
                            <td>
                                {% if record[6] == 'Present' %}
                                <span class="status-badge present">‚úì Present</span>
                                {% elif record[6] == 'Absent' %}
                                <span class="status-badge absent">‚úó Absent</span>
                                {% elif record[6] == 'Sick' %}
                                <span class="status-badge sick">üè• Sick</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ record[6] }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <i class="fa fa-calendar-times-o fa-3x text-muted mb-3" style="display: block;"></i>
                                <h5 class="text-muted">No attendance records found</h5>
                                <p class="text-muted">Try adjusting your filters or date range</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if pages > 1 %}
        <div class="p-3 bg-light">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}&search={{ search_query }}&branch={{ selected_branch }}&start_date={{ start_date }}&end_date={{ end_date }}">
                            <i class="fa fa-chevron-left"></i> Previous
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for p in range(1, pages + 1) %}
                        {% if p == page %}
                        <li class="page-item active">
                            <span class="page-link" style="background: #14860C; border-color: #14860C;">{{ p }}</span>
                        </li>
                        {% elif p <= 3 or p > pages - 3 or (p >= page - 1 and p <= page + 1) %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ p }}&search={{ search_query }}&branch={{ selected_branch }}&start_date={{ start_date }}&end_date={{ end_date }}">{{ p }}</a>
                        </li>
                        {% elif p == 4 or p == pages - 3 %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page < pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}&search={{ search_query }}&branch={{ selected_branch }}&start_date={{ start_date }}&end_date={{ end_date }}">
                            Next <i class="fa fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}
